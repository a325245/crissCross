<!DOCTYPE html>
<html>
<head>
    <title>Magic Crossword (v2.4)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 600px; 
            margin: 0 auto; 
            background: #f0f2f5; 
            padding: 10px; 
            padding-top: 90px; /* Space for the top bar */
        }
        
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; font-size: 1.2rem; }

        .version-badge { 
            background: #e8f5e9; color: #1b5e20; 
            padding: 4px 8px; border-radius: 4px; 
            font-size: 0.75rem; font-weight: bold; 
            display: inline-block; margin-bottom: 10px;
        }

        /* Top Clue Bar (Fixed) */
        #active-clue-bar { 
            position: fixed; 
            top: 0; left: 0; right: 0; 
            background: #222; 
            color: #fff; 
            padding: 12px; 
            z-index: 1000;
            border-bottom: 4px solid #007bff; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.95rem;
            line-height: 1.3;
        }
        .clue-label { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px; }

        /* Controls */
        .controls input, .controls button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #b0bec5; cursor: wait; }

        /* Grid Styling */
        #game-board { margin-top: 10px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { border-collapse: collapse; margin: 0 auto; background: #000; border: 2px solid #000; }
        td { 
            width: 38px; height: 38px; /* Bigger touch targets */
            border: 1px solid #555; 
            background: white; 
            position: relative; 
            padding: 0;
        }
        td.black-cell { background-color: #222; }
        
        td input { 
            width: 100%; height: 100%; border: none; 
            text-align: center; font-size: 22px; /* Large text */
            text-transform: uppercase; font-weight: bold; 
            background: transparent; padding: 0; margin: 0; 
            color: #222; border-radius: 0; 
            z-index: 2; position: relative;
            font-family: monospace;
        }
        td input:focus { background-color: #e3f2fd; outline: none; }
        
        /* The Tiny Numbers */
        .num { 
            position: absolute; top: 1px; left: 2px; 
            font-size: 9px; color: #444; pointer-events: none; z-index: 1; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="active-clue-bar">
    <div>Tap a square to start!</div>
</div>

<div class="container" id="setup-panel">
    <h2>ðŸ“¸ Magic Crossword</h2>
    <div class="version-badge">v2.4: Top Bar + Precise Grid</div>
    
    <div class="controls">
        <label style="font-size:0.9rem; color:#666;">API Key:</label>
        <input type="password" id="apiKey" placeholder="AIzaSy...">
        
        <input type="hidden" id="modelName" value="gemini-2.5-flash">

        <label style="font-size:0.9rem; color:#666;">Photo:</label>
        <input type="file" id="imageInput" accept="image/*">

        <button id="btn-convert" onclick="convertCrossword()">âœ¨ Generate Game</button>
        <div id="status" style="margin-top:10px; text-align:center; color:#666; font-size: 0.9rem;"></div>
    </div>
</div>

<div id="game-board"></div>

<script>
    // --- 1. UTILS ---
    function compressImage(file, maxSize = 800) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
                    else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // --- 2. GAME LOGIC ---
    function attachGameLogic() {
        const inputs = document.querySelectorAll('td input');
        inputs.forEach(input => {
            input.onfocus = (e) => showClue(e.target);
            input.onkeydown = (e) => handleKey(e, input);
        });
    }

    function handleKey(e, input) {
        // Allow backspace to move back
        if (e.key === 'Backspace' && input.value === '') {
            moveFocus(input, -1);
        }
    }

    function moveFocus(currentInput, direction) {
        // Find next input in DOM order (works for Across)
        const inputs = Array.from(document.querySelectorAll('td input'));
        const idx = inputs.indexOf(currentInput);
        if (idx + direction >= 0 && idx + direction < inputs.length) {
            inputs[idx + direction].focus();
        }
    }

    function showClue(activeInput) {
        const cell = activeInput.parentElement;
        const row = cell.parentElement;
        
        // Find Across
        let currentTd = cell, acrossClue = "---";
        while (currentTd) {
            const inp = currentTd.querySelector('input');
            if (inp && inp.dataset.across) { acrossClue = inp.dataset.across; break; }
            if (currentTd.classList.contains('black-cell') || !currentTd.previousElementSibling) break;
            currentTd = currentTd.previousElementSibling;
        }

        // Find Down
        let currentRow = row, colIndex = Array.from(row.children).indexOf(cell), downClue = "---";
        while (currentRow) {
            const tdAbove = currentRow.children[colIndex];
            const inp = tdAbove ? tdAbove.querySelector('input') : null;
            if (inp && inp.dataset.down) { downClue = inp.dataset.down; break; }
            if (!tdAbove || tdAbove.classList.contains('black-cell') || !currentRow.previousElementSibling) break;
            currentRow = currentRow.previousElementSibling;
        }

        const bar = document.getElementById('active-clue-bar');
        bar.innerHTML = `
            <div style="width:100%">
                <div class="clue-label">Across</div>
                <div style="font-weight:bold; margin-bottom:4px">${acrossClue}</div>
                <div class="clue-label">Down</div>
                <div style="font-weight:bold">${downClue}</div>
            </div>
        `;
    }

    // --- 3
