<!DOCTYPE html>
<html>
<head>
    <title>Magic Crossword (v2.0)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; background: #f4f4f9; padding: 10px; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }

        /* Controls */
        .controls input, .controls select, .controls button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        
        /* The Active Clue Bar (Sticky at bottom) */
        #active-clue-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #222; color: #fff; padding: 15px; 
            text-align: center; font-size: 1.1em; z-index: 100;
            border-top: 4px solid #007bff; display: none;
        }

        /* The Grid */
        #game-board { margin-top: 20px; overflow-x: auto; padding-bottom: 60px; }
        table { border-collapse: collapse; margin: 0 auto; background: #000; border: 2px solid #000; }
        td { 
            width: 34px; height: 34px; 
            border: 1px solid #555; 
            background: white; 
            position: relative; 
            padding: 0;
        }
        
        /* Black Squares */
        td.black { background-color: #222; }

        /* The Input Box */
        td input { 
            width: 100%; height: 100%; border: none; 
            text-align: center; font-size: 18px; 
            text-transform: uppercase; font-weight: bold; 
            background: transparent; padding: 0; margin: 0; 
            color: #333; border-radius: 0;
        }
        td input:focus { background-color: #fff9c4; outline: none; }

        /* The Tiny Numbers */
        .cell-number { 
            position: absolute; top: 1px; left: 1px; 
            font-size: 9px; color: #666; pointer-events: none; line-height: 1;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üß© Playable Crossword</h2>
    
    <div class="controls" id="setup-panel">
        <label>API Key:</label>
        <input type="password" id="apiKey" placeholder="Paste Key Here...">
        
        <label>Model:</label>
        <select id="modelSelect">
            <option value="gemini-2.5-flash">Gemini 2.5 Flash (Best)</option>
            <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        </select>

        <label>Photo:</label>
        <input type="file" id="imageInput" accept="image/*">

        <button onclick="convertCrossword()">‚ú® Generate Game</button>
        <div id="status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="game-board"></div>
</div>

<div id="active-clue-bar">Tap a square to see the clue!</div>

<script>
    // --- 1. THE GAME ENGINE (Handles the logic) ---
    let puzzleData = null;

    function renderGame(data) {
        puzzleData = data;
        const board = document.getElementById('game-board');
        const setup = document.getElementById('setup-panel');
        const clueBar = document.getElementById('active-clue-bar');
        
        setup.style.display = 'none'; // Hide setup
        clueBar.style.display = 'block'; // Show clue bar
        board.innerHTML = '';

        const table = document.createElement('table');

        // Build the grid
        data.grid.forEach((row, rIndex) => {
            const tr = document.createElement('tr');
            row.forEach((cell, cIndex) => {
                const td = document.createElement('td');
                
                if (cell === '#') {
                    td.className = 'black';
                } else {
                    // Create input for letter
                    const input = document.createElement('input');
                    input.maxLength = 1;
                    input.dataset.row = rIndex;
                    input.dataset.col = cIndex;
                    
                    // Add interactions
                    input.onfocus = () => showClue(rIndex, cIndex);
                    input.oninput = (e) => {
                        // Auto-move to next box if typing a letter
                        if(e.target.value) moveFocus(rIndex, cIndex + 1); 
                    };

                    // Render small number if it exists
                    if (typeof cell === 'number') {
                        const numSpan = document.createElement('span');
                        numSpan.className = 'cell-number';
                        numSpan.innerText = cell;
                        td.appendChild(numSpan);
                    }
                    td.appendChild(input);
                }
                tr.appendChild(td);
            });
            table.appendChild(tr);
        });
        board.appendChild(table);
    }

    function showClue(row, col) {
        // Logic: Find the "Across" number by walking left until we hit a black square
        let startCol = col;
        while (startCol > 0 && puzzleData.grid[row][startCol - 1] !== '#') {
            startCol--;
        }
        
        // Logic: Find the "Down" number by walking up
        let startRow = row;
        while (startRow > 0 && puzzleData.grid[startRow - 1][col] !== '#') {
            startRow--;
        }

        // Get the clue numbers from those start positions
        const acrossNum = puzzleData.grid[row][startCol];
        const downNum = puzzleData.grid[startRow][col];

        // Fetch text
        const acrossText = puzzleData.clues.across[acrossNum] || "(No Across Clue)";
        const downText = puzzleData.clues.down[downNum] || "(No Down Clue)";

        // Update the sticky bar
        document.getElementById('active-clue-bar').innerHTML = 
            `<b>A:</b> ${acrossText} <span style='color:#555'>|</span> <b>D:</b> ${downText}`;
    }

    function moveFocus(r, c) {
        // Simple helper to jump to next input
        const nextInput = document.querySelector(`input[data-row='${r}'][data-col='${c}']`);
        if (nextInput) nextInput.focus();
    }

    // --- 2. THE AI CALL (Fetches the data) ---
    async function convertCrossword() {
        const apiKey = document.getElementById('apiKey').value;
        const model = document.getElementById('modelSelect').value;
        const fileInput = document.getElementById('imageInput');
        const status = document.getElementById('status');

        if (!apiKey || fileInput.files.length === 0) return alert("Missing Key or Photo");

        status.innerHTML = "üß† Analyzing grid structure... (This is harder than just reading!)";

        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onloadend = async function() {
            const base64Image = reader.result.split(',')[1];
            
            // We ask for JSON specifically
            const prompt = `
                Analyze this crossword image. Output ONLY a valid JSON object.
                Structure:
                {
                    "grid": [ ["#", 1, 2, "#"], [3, ".", ".", 4] ], 
                    "clues": { 
                        "across": { "1": "Clue text", "3": "Clue text" },
                        "down": { "2": "Clue text" }
                    }
                }
                Rules:
                1. "grid": 2D array. Use '#' for black squares. Use the integer number for squares that start a word. Use "." (string dot) for empty white squares.
                2. "clues": Object mapping the number to the text.
                3. Do NOT include markdown formatting. Return raw JSON only.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: file.type || "image/jpeg", data: base64Image } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                
                let jsonText = data.candidates[0].content.parts[0].text;
                // Clean up if AI adds markdown blocks
                jsonText = jsonText.replace(/```json|```/g, '').trim();
                
                const puzzle = JSON.parse(jsonText);
                renderGame(puzzle);
                status.innerHTML = "";

            } catch (error) {
                status.innerHTML = "‚ùå Error: " + error.message;
            }
        };
        reader.readAsDataURL(file);
    }
</script>

</body>
</html>
