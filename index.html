<!DOCTYPE html>
<html>
<head>
    <title>Magic Crossword (v2.1)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; background: #f4f4f9; padding: 10px; padding-bottom: 80px; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }

        /* Version Header */
        .version-badge { background: #eee; color: #555; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; margin-bottom: 15px; display: inline-block; }

        /* Controls */
        .controls input, .controls select, .controls button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        
        /* The Active Clue Bar (Sticky at bottom) */
        #active-clue-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #222; color: #fff; padding: 15px; 
            text-align: center; font-size: 1em; z-index: 100;
            border-top: 4px solid #007bff; display: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        /* The Grid */
        #game-board { margin-top: 20px; overflow-x: auto; }
        
        /* AI Generated Table Styles */
        table { border-collapse: collapse; margin: 0 auto; background: #000; border: 2px solid #000; }
        td { 
            width: 36px; height: 36px; 
            border: 1px solid #555; 
            background: white; 
            position: relative; 
            padding: 0;
        }
        td.black-cell { background-color: #222; }
        
        /* The Inputs inside the grid */
        td input { 
            width: 100%; height: 100%; border: none; 
            text-align: center; font-size: 20px; 
            text-transform: uppercase; font-weight: bold; 
            background: transparent; padding: 0; margin: 0; 
            color: #333; border-radius: 0; 
            z-index: 2; position: relative;
        }
        td input:focus { background-color: #fff9c4; outline: none; }

        /* The Tiny Numbers */
        .num { 
            position: absolute; top: 1px; left: 2px; 
            font-size: 10px; color: #666; pointer-events: none; z-index: 1; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üß© Playable Crossword</h2>
    <div class="version-badge">
        <b>v2.1 Changelog:</b> Reverted to HTML Grid (Better visuals), Fixed Clue Logic.
    </div>
    
    <div class="controls" id="setup-panel">
        <label>API Key:</label>
        <input type="password" id="apiKey" placeholder="Paste Key Here...">
        
        <label>Model:</label>
        <select id="modelSelect">
            <option value="gemini-2.0-flash">Gemini 2.0 Flash (Fast & Stable)</option>
            <option value="gemini-2.5-flash">Gemini 2.5 Flash (Smarter)</option>
        </select>

        <label>Photo:</label>
        <input type="file" id="imageInput" accept="image/*">

        <button onclick="convertCrossword()">‚ú® Generate Game</button>
        <div id="status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="game-board"></div>
</div>

<div id="active-clue-bar">Tap a square to see the clue!</div>

<script>
    // --- 1. THE GAME LOGIC (Finds clues by walking backwards) ---
    
    function attachGameLogic() {
        const inputs = document.querySelectorAll('td input');
        
        inputs.forEach(input => {
            input.onfocus = (e) => showClue(e.target);
            
            // Auto-move focus on type
            input.oninput = (e) => {
                if(e.target.value.length === 1) {
                    // Try to move right one cell (simple heuristic)
                    const parentTd = e.target.parentElement;
                    const nextTd = parentTd.nextElementSibling;
                    if(nextTd && nextTd.querySelector('input')) {
                        nextTd.querySelector('input').focus();
                    }
                }
            };
        });
    }

    function showClue(activeInput) {
        const cell = activeInput.parentElement;
        const row = cell.parentElement;
        const table = row.parentElement;

        // 1. Find ACROSS Clue: Walk LEFT until we hit a black square or edge
        let currentTd = cell;
        let acrossClue = "---";
        while (currentTd) {
            // Check if this cell has the "data-across" attribute stored on its input
            const inp = currentTd.querySelector('input');
            if (inp && inp.dataset.across) {
                acrossClue = inp.dataset.across;
                break; 
            }
            if (currentTd.classList.contains('black-cell') || !currentTd.previousElementSibling) break;
            currentTd = currentTd.previousElementSibling;
        }

        // 2. Find DOWN Clue: Walk UP until we hit a black square or edge
        let currentRow = row;
        let colIndex = Array.from(row.children).indexOf(cell);
        let downClue = "---";
        
        while (currentRow) {
            const tdAbove = currentRow.children[colIndex];
            const inp = tdAbove ? tdAbove.querySelector('input') : null;
            
            if (inp && inp.dataset.down) {
                downClue = inp.dataset.down;
                break;
            }
            // Stop if we hit top or black cell
            if (!tdAbove || tdAbove.classList.contains('black-cell') || !currentRow.previousElementSibling) break;
            currentRow = currentRow.previousElementSibling;
        }

        // Display
        const clueBar = document.getElementById('active-clue-bar');
        clueBar.style.display = 'block';
        clueBar.innerHTML = `<b>A:</b> ${acrossClue}<br><b>D:</b> ${downClue}`;
    }


    // --- 2. THE AI CALL ---
    async function convertCrossword() {
        const apiKey = document.getElementById('apiKey').value;
        const model = document.getElementById('modelSelect').value;
        const fileInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const board = document.getElementById('game-board');

        if (!apiKey || fileInput.files.length === 0) return alert("Missing Key or Photo");

        status.innerHTML = "üß† Analyzing image... (Generating Smart HTML)";
        board.innerHTML = "";

        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onloadend = async function() {
            const base64Image = reader.result.split(',')[1];
            
            // THE MAGIC PROMPT (Version 2.1)
            // We ask for HTML (for looks) but with data-attributes (for logic)
            const prompt = `
                Look at this crossword. Generate the HTML code for a playable version.
                
                Rules:
                1. Create a standard HTML <table>.
                2. Black squares: <td class="black-cell"></td>
                3. White squares: <td><input maxlength="1"></td>
                
                CRITICAL DATA INJECTION:
                4. If a white square has a small number (e.g., 5), add a <span class="num">5</span> inside the td.
                5. ALSO, if that square starts a word, add the CLUE TEXT to the input as a data attribute.
                   Example: <input data-across="5. A baked treat" data-down="5. To move quickly">
                
                6. Do not wrap in markdown or '''html code blocks. Just return the raw table HTML.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: file.type || "image/jpeg", data: base64Image } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);
                if (!data.candidates) throw new Error("AI returned no content");

                let html = data.candidates[0].content.parts[0].text;
                
                // Cleanup markdown if the AI was naughty
                html = html.replace(/```html|```/g, '');

                board.innerHTML = html;
                document.getElementById('setup-panel').style.display = 'none'; // Hide controls to focus on game
                
                // Activate the JavaScript logic on the new inputs
                attachGameLogic();
                
                status.innerHTML = "‚úÖ Game Ready!";

            } catch (error) {
                status.innerHTML = "‚ùå Error: " + error.message;
                document.getElementById('setup-panel').style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
</script>

</body>
</html>
