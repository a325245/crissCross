<!DOCTYPE html>
<html>
<head>
    <title>Magic Crossword (v2.3)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; background: #f4f4f9; padding: 10px; padding-bottom: 80px; }
        .container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }

        .version-badge { background: #e8f5e9; color: #2e7d32; padding: 5px 10px; border-radius: 4px; font-size: 0.8em; margin-bottom: 15px; display: inline-block; font-weight: bold;}

        /* Controls */
        .controls input, .controls button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background-color: #2e7d32; color: white; font-weight: bold; border: none; cursor: pointer; transition: background 0.2s; }
        button:hover { background-color: #1b5e20; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Sticky Clue Bar */
        #active-clue-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #222; color: #fff; padding: 15px; 
            text-align: center; font-size: 1em; z-index: 100;
            border-top: 4px solid #2e7d32; display: none; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        /* Grid Styling */
        #game-board { margin-top: 20px; overflow-x: auto; min-height: 200px;}
        table { border-collapse: collapse; margin: 0 auto; background: #000; border: 2px solid #000; }
        td { 
            width: 36px; height: 36px; 
            border: 1px solid #555; 
            background: white; 
            position: relative; 
            padding: 0;
        }
        td.black-cell { background-color: #222; }
        td input { 
            width: 100%; height: 100%; border: none; 
            text-align: center; font-size: 20px; 
            text-transform: uppercase; font-weight: bold; 
            background: transparent; padding: 0; margin: 0; 
            color: #333; border-radius: 0; 
            z-index: 2; position: relative;
        }
        td input:focus { background-color: #fff9c4; outline: none; }
        .num { 
            position: absolute; top: 1px; left: 2px; 
            font-size: 10px; color: #666; pointer-events: none; z-index: 1; font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üß© Magic Crossword</h2>
    <div class="version-badge">
        <b>v2.3 Strategy Change:</b> "Recognition First, Vision Second"
    </div>
    
    <div class="controls" id="setup-panel">
        <label>API Key:</label>
        <input type="password" id="apiKey" placeholder="Paste Key Here...">
        
        <input type="hidden" id="modelName" value="gemini-2.5-flash">

        <label>Photo:</label>
        <input type="file" id="imageInput" accept="image/*">

        <button id="btn-convert" onclick="convertCrossword()">‚ú® Identify & Build</button>
        <div id="status" style="margin-top:10px; text-align:center; color:#666;"></div>
    </div>

    <div id="game-board"></div>
</div>

<div id="active-clue-bar">Tap a square to see the clue!</div>

<script>
    // --- 1. IMAGE COMPRESSION ---
    function compressImage(file, maxSize = 1000) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // --- 2. GAME LOGIC ---
    function attachGameLogic() {
        const inputs = document.querySelectorAll('td input');
        inputs.forEach(input => {
            input.onfocus = (e) => showClue(e.target);
            input.oninput = (e) => {
                if(e.target.value.length === 1) {
                    const parentTd = e.target.parentElement;
                    const nextTd = parentTd.nextElementSibling;
                    if(nextTd && nextTd.querySelector('input')) {
                        nextTd.querySelector('input').focus();
                    }
                }
            };
        });
    }

    function showClue(activeInput) {
        const cell = activeInput.parentElement;
        const row = cell.parentElement;
        
        let currentTd = cell;
        let acrossClue = "---";
        while (currentTd) {
            const inp = currentTd.querySelector('input');
            if (inp && inp.dataset.across) { acrossClue = inp.dataset.across; break; }
            if (currentTd.classList.contains('black-cell') || !currentTd.previousElementSibling) break;
            currentTd = currentTd.previousElementSibling;
        }

        let currentRow = row;
        let colIndex = Array.from(row.children).indexOf(cell);
        let downClue = "---";
        while (currentRow) {
            const tdAbove = currentRow.children[colIndex];
            const inp = tdAbove ? tdAbove.querySelector('input') : null;
            if (inp && inp.dataset.down) { downClue = inp.dataset.down; break; }
            if (!tdAbove || tdAbove.classList.contains('black-cell') || !currentRow.previousElementSibling) break;
            currentRow = currentRow.previousElementSibling;
        }

        document.getElementById('active-clue-bar').style.display = 'block';
        document.getElementById('active-clue-bar').innerHTML = `<b>A:</b> ${acrossClue}<br><b>D:</b> ${downClue}`;
    }

    // --- 3. AI CALL (UPDATED PROMPT) ---
    async function convertCrossword() {
        const apiKey = document.getElementById('apiKey').value;
        const model = document.getElementById('modelName').value;
        const fileInput = document.getElementById('imageInput');
        const status = document.getElementById('status');
        const btn = document.getElementById('btn-convert');
        const board = document.getElementById('game-board');

        if (!apiKey || fileInput.files.length === 0) return alert("Missing Key or Photo");

        btn.disabled = true;
        status.innerHTML = "üìâ Processing Image...";
        board.innerHTML = "";

        try {
            const file = fileInput.files[0];
            const base64Image = await compressImage(file);
            status.innerHTML = "üß† Identifying Puzzle...";

            // --- THE NEW STRATEGY ---
            const prompt = `
                I am sending you an image of a crossword.
                
                PHASE 1: IDENTIFICATION
                Read the first 3-4 visible clues and the general grid layout.
                Search your internal knowledge: Do you recognize this specific puzzle (e.g. from NYT, LA Times, etc)?
                
                PHASE 2: GENERATION
                If you recognize it: Ignore the visual artifacts and generate the PERFECT grid/clues from your memory.
                If you do NOT recognize it: Visually reconstruct it as best you can.
                
                OUTPUT FORMAT:
                Return ONLY raw HTML for a table.
                1. <table>...</table>
                2. Use <td class="black-cell"></td> for black squares.
                3. Use <td><input maxlength="1"></td> for white squares.
                4. CRITICAL: Inject data.
                   - Add <span class="num">X</span> for numbers.
                   - Add data-across="X. Clue Text" and data-down="Y. Clue Text" to the input where a word starts.
                
                Do NOT output markdown. Just the HTML.
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });

            if (!response.ok) throw new Error(`Server Error: ${response.status}`);

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            if (!data.candidates) throw new Error("AI returned no content");

            let html = data.candidates[0].content.parts[0].text;
            html = html.replace(/```html|```/g, '');

            board.innerHTML = html;
            document.getElementById('setup-panel').style.display = 'none';
            attachGameLogic();
            status.innerHTML = "‚úÖ Puzzle Loaded!";

        } catch (error) {
            status.innerHTML = "‚ùå Error: " + error.message;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
